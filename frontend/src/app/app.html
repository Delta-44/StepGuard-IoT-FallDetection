<div style="font-family: 'Segoe UI', sans-serif; min-height: 100vh; display: flex; flex-direction: column;">
      
  @if (criticalAlert() && showNavbar()) {
    <div class="critical-banner">
      <div class="banner-content">
        <i-lucide name="alert-triangle" class="banner-icon" [size]="28"></i-lucide>
        <div>
          <strong>¡EMERGENCIA CRÍTICA!</strong>
          <span style="margin-left: 10px; font-weight: 400; opacity: 0.9;">
            {{ criticalAlert()?.message }} en <u>{{ criticalAlert()?.location }}</u>
          </span>
        </div>
      </div>
      
      <button (click)="goToDashboard()" class="btn-banner-action">
        Ver y Atender
      </button>
    </div>
  }

  @if (showNavbar()) {
    <nav class="bg-gray-900 text-white shadow-lg sticky top-0 z-40 border-b border-gray-800">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          
          <!-- Logo -->
          <div class="flex-shrink-0">
            <div class="flex items-center gap-2 select-none">
              <div class="bg-blue-600 p-1.5 rounded-lg">
                <i-lucide name="shield" [size]="24" class="text-white"></i-lucide>
              </div>
              <span class="font-bold text-xl tracking-tight cursor-default">StepGuard IoT</span>
            </div>
          </div>

          <!-- Desktop Navigation -->
          <div class="hidden md:block">
            <div class="ml-10 flex items-baseline space-x-4">
              @if (currentUser()) {
                @if (currentUser()?.role === 'user') {
                  <a routerLink="/alerts" routerLinkActive="bg-gray-800 text-white" class="px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-700 transition-all flex items-center gap-2">
                    <i-lucide name="bell" [size]="16"></i-lucide> Mis Incidencias
                  </a>
                } @else {
                  <a routerLink="/dashboard" routerLinkActive="bg-gray-800 text-white" class="px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-700 transition-all flex items-center gap-2">
                    <i-lucide name="activity" [size]="16"></i-lucide> Monitorización
                  </a>
                  <a routerLink="/devices" routerLinkActive="bg-gray-800 text-white" class="px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-700 transition-all flex items-center gap-2">
                    <i-lucide name="smartphone" [size]="16"></i-lucide> Dispositivos
                  </a>
                  <a routerLink="/alerts" routerLinkActive="bg-gray-800 text-white" class="px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-700 transition-all flex items-center gap-2">
                    <i-lucide name="bell" [size]="16"></i-lucide> Historial
                  </a>

                  @if (currentUser()?.role === 'admin' || currentUser()?.role === 'caregiver') {
                    <a routerLink="/users" routerLinkActive="bg-gray-800 text-white" class="px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-700 transition-all flex items-center gap-2">
                      <i-lucide name="users" [size]="16"></i-lucide>
                      {{ isAdmin() ? 'Gestión Usuarios' : 'Lista Pacientes' }}
                    </a>
                  }
                }
              }
            </div>
          </div>

          <!-- Desktop User Profile & Dropdown -->
          <div class="hidden md:block relative">
            <div class="flex items-center gap-4">
              @if (currentUser()) {
                <div class="flex items-center gap-3">
                  <div class="flex flex-col items-end">
                    <div class="text-sm font-bold text-white max-w-[150px] truncate whitespace-nowrap" [title]="currentUser()?.fullName">{{ currentUser()?.fullName }}</div>
                    <div class="text-xs text-gray-400 flex items-center justify-end gap-1">
                      @switch (currentUser()?.role) {
                        @case ('admin') { <i-lucide name="settings" [size]="12"></i-lucide> <span>Administrador</span> }
                        @case ('caregiver') { <i-lucide name="user-circle" [size]="12"></i-lucide> <span>Cuidador</span> }
                        @case ('user') { <i-lucide name="user-circle" [size]="12"></i-lucide> <span>Paciente</span> }
                      }
                    </div>
                  </div>
                  
                  <!-- Dropdown Trigger (Foto de Perfil) -->
                  <button (click)="toggleProfileDropdown()" class="relative focus:outline-none">
                    <div class="h-10 w-10 rounded-full bg-blue-600 flex items-center justify-center overflow-hidden border-2 border-gray-700 hover:border-blue-400 transition-colors cursor-pointer">
                      @if (currentUser()?.foto_perfil) {
                        <img [src]="currentUser()?.foto_perfil" alt="Perfil" class="w-full h-full object-cover">
                      } @else {
                        <span class="text-white font-bold text-lg">{{ currentUser()?.fullName?.charAt(0) }}</span>
                      }
                    </div>
                  </button>

                  <!-- Dropdown Menu -->
                  @if (isProfileDropdownOpen()) {
                    <div class="absolute right-0 top-12 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 ring-1 ring-black ring-opacity-5 animate-in fade-in slide-in-from-top-2 duration-200">
                      <div class="px-4 py-2 border-b border-gray-100">
                        <p class="text-xs text-gray-500">Conectado como</p>
                        <p class="text-sm font-bold text-gray-900 truncate">{{ currentUser()?.fullName }}</p>
                      </div>

                      <a routerLink="/profile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2">
                        <i-lucide name="user" [size]="16"></i-lucide> Mi Perfil
                      </a>
                      
                      <button (click)="logout()" class="w-full text-left block px-4 py-2 text-sm text-red-600 hover:bg-gray-100 flex items-center gap-2">
                        <i-lucide name="log-out" [size]="16"></i-lucide> Cerrar Sesión
                      </button>
                    </div>
                  }
                  
                  <!-- Overlay invisible para cerrar al hacer click fuera -->
                  @if (isProfileDropdownOpen()) {
                    <div class="fixed inset-0 z-40" (click)="closeProfileDropdown()"></div>
                  }
                </div>
              } @else {
                <a routerLink="/" class="text-gray-300 hover:text-white font-medium transition-colors">Iniciar Sesión</a>
              }
            </div>
          </div>

          <!-- Mobile Menu Button -->
          <div class="-mr-2 flex md:hidden">
            @if (currentUser()) {
              <button (click)="toggleMenu()" class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white">
                <span class="sr-only">Abrir menú</span>
                @if (isMobileMenuOpen()) {
                  <i-lucide name="x" [size]="24"></i-lucide>
                } @else {
                  <i-lucide name="menu" [size]="24"></i-lucide>
                }
              </button>
            }
          </div>
        </div>
      </div>

      <!-- Mobile Menu (Conditional) -->
      @if (isMobileMenuOpen() && currentUser()) {
        <div class="md:hidden bg-gray-800 border-t border-gray-700 animate-slide-down">
          <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
            @if (currentUser()?.role === 'user') {
              <a routerLink="/alerts" (click)="closeMenu()" routerLinkActive="bg-gray-900 text-white" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium flex items-center gap-2">
                <i-lucide name="bell" [size]="18"></i-lucide> Mis Incidencias
              </a>
            } @else {
              <a routerLink="/dashboard" (click)="closeMenu()" routerLinkActive="bg-gray-900 text-white" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium flex items-center gap-2">
                <i-lucide name="activity" [size]="18"></i-lucide> Monitorización
              </a>
              <a routerLink="/devices" (click)="closeMenu()" routerLinkActive="bg-gray-900 text-white" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium flex items-center gap-2">
                <i-lucide name="smartphone" [size]="18"></i-lucide> Dispositivos
              </a>
              <a routerLink="/alerts" (click)="closeMenu()" routerLinkActive="bg-gray-900 text-white" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium flex items-center gap-2">
                <i-lucide name="bell" [size]="18"></i-lucide> Historial
              </a>

              @if (currentUser()?.role === 'admin' || currentUser()?.role === 'caregiver') {
                <a routerLink="/users" (click)="closeMenu()" routerLinkActive="bg-gray-900 text-white" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium flex items-center gap-2">
                  <i-lucide name="users" [size]="18"></i-lucide>
                  {{ isAdmin() ? 'Gestión Usuarios' : 'Lista Pacientes' }}
                </a>
              }
            }
          </div>
          
          <div class="pt-4 pb-4 border-t border-gray-700">
            <div class="flex items-center px-5">
              <div class="flex-shrink-0">
                <a routerLink="/profile" (click)="closeMenu()" class="h-10 w-10 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-lg overflow-hidden border-2 border-transparent hover:border-white transition-all">
                  @if (currentUser()?.foto_perfil) {
                    <img [src]="currentUser()?.foto_perfil" alt="Perfil" class="w-full h-full object-cover">
                  } @else {
                    {{ currentUser()?.fullName?.charAt(0) }}
                  }
                </a>
              </div>
              <div class="ml-3">
                <div class="text-base font-medium leading-none text-white">{{ currentUser()?.fullName }}</div>
                <div class="text-sm font-medium leading-none text-gray-400 mt-1 capitalize">{{ currentUser()?.role || 'Usuario' }}</div>
              </div>
              <button (click)="logout()" class="ml-auto bg-red-600 p-2 rounded-full text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white">
                <i-lucide name="log-out" [size]="20"></i-lucide>
              </button>
            </div>
          </div>
        </div>
      }
    </nav>
  }

  <div class="flex-1 relative bg-gray-100">
    <router-outlet></router-outlet>
  </div>

  @if (currentUser() && showNavbar() && canViewAnalytics()) {
    <button class="fab-analytics" (click)="openGrafanaDashboard()">
      <i-lucide name="layout-dashboard" [size]="18"></i-lucide>
      <span>Analítica</span>
    </button>
  }

  @if (miniAlert()) {
    <div class="toast-notification" [ngClass]="miniAlert()?.severity">
      <div class="toast-icon">
        @if (miniAlert()?.severity === 'high') { 
          <i-lucide name="alert-triangle" [size]="20"></i-lucide>
        }
        @else if (miniAlert()?.severity === 'medium') { 
          <i-lucide name="bell" [size]="20"></i-lucide>
        }
        @else { 
          <i-lucide name="circle-alert" [size]="20"></i-lucide>
        }
      </div>
      <div class="toast-content">
        <h4>Nueva Alerta Detectada</h4>
        <p>{{ miniAlert()?.message }}</p>
        <small><i-lucide name="map-pin" [size]="12"></i-lucide> {{ miniAlert()?.location }}</small>
      </div>
      <div class="toast-actions">
        <button class="btn-toast-view" (click)="goToDashboardFromMini()">Atender</button>
        <button class="btn-toast-close" (click)="closeMiniAlert()">✕</button>
      </div>
      <div class="progress-bar"></div>
    </div>
  }

  <!-- Componente de Notificaciones -->
  <app-notification></app-notification>

  <!-- Chatbot (solo visible para usuarios autenticados) -->
  @if (currentUser() && showNavbar()) {
    <app-chatbot></app-chatbot>
  }

</div>