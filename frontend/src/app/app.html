<div class="min-h-screen flex flex-col bg-white dark:bg-gray-900 transition-colors duration-300" style="font-family: 'Segoe UI', sans-serif;">
      
  @if (criticalAlert() && showNavbar()) {
    <div class="critical-banner">
      <div class="banner-content">
        <i-lucide name="alert-triangle" class="banner-icon" [size]="28"></i-lucide>
        <div>
          <strong>¬°EMERGENCIA CR√çTICA!</strong>
          <span style="margin-left: 10px; font-weight: 400; opacity: 0.9;">
            {{ criticalAlert()?.message }} en <u>{{ criticalAlert()?.location }}</u>
          </span>
        </div>
      </div>
      
      <button (click)="goToDashboard()" class="btn-banner-action">
        Ver y Atender
      </button>
    </div>
  }

  @if (showNavbar()) {
    <nav class="bg-gray-900 dark:bg-gray-950 text-white shadow-lg sticky top-0 z-40 border-b border-gray-800 dark:border-gray-700 transition-colors duration-300">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          
          <!-- Logo -->
          <div class="flex-shrink-0">
            <a routerLink="/" class="flex items-center gap-2 group">
              <div class="bg-blue-600 p-1.5 rounded-lg group-hover:bg-blue-500 transition-colors">
                <i-lucide name="shield" [size]="24" class="text-white"></i-lucide>
              </div>
              <span class="font-bold text-xl tracking-tight">StepGuard IoT</span>
            </a>
          </div>

          <!-- Desktop Navigation -->
          <div class="hidden md:block">
            <div class="ml-10 flex items-baseline space-x-4">
              @if (currentUser()) {
                @if (currentUser()?.role === 'user') {
                  <a routerLink="/profile" routerLinkActive="bg-gray-800 text-white" class="px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-700 transition-all flex items-center gap-2">
                    <i-lucide name="user" [size]="16"></i-lucide> Mi Perfil
                  </a>
                  <a routerLink="/alerts" routerLinkActive="bg-gray-800 text-white" class="px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-700 transition-all flex items-center gap-2">
                    <i-lucide name="bell" [size]="16"></i-lucide> Mis Incidencias
                  </a>
                } @else {
                  <a routerLink="/dashboard" routerLinkActive="bg-gray-800 text-white" class="px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-700 transition-all flex items-center gap-2">
                    <i-lucide name="activity" [size]="16"></i-lucide> Monitorizaci√≥n
                  </a>
                  <a routerLink="/devices" routerLinkActive="bg-gray-800 text-white" class="px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-700 transition-all flex items-center gap-2">
                    <i-lucide name="smartphone" [size]="16"></i-lucide> Dispositivos
                  </a>
                  <a routerLink="/alerts" routerLinkActive="bg-gray-800 text-white" class="px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-700 transition-all flex items-center gap-2">
                    <i-lucide name="bell" [size]="16"></i-lucide> Historial
                  </a>

                  @if (currentUser()?.role === 'admin' || currentUser()?.role === 'caregiver') {
                    <a routerLink="/users" routerLinkActive="bg-gray-800 text-white" class="px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-700 transition-all flex items-center gap-2">
                      <i-lucide name="users" [size]="16"></i-lucide>
                      {{ isAdmin() ? 'Gesti√≥n Usuarios' : 'Lista Pacientes' }}
                    </a>
                  }
                }
              }
            </div>
          </div>

          <!-- Desktop User Profile & Logout -->
          <div class="hidden md:block">
            <div class="flex items-center gap-4">
              @if (currentUser()) {
                <!-- Bot√≥n de tema -->
                <button
                  (click)="themeService.toggleTheme()"
                  class="p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition-all text-gray-300 hover:text-white"
                  [title]="themeService.isDarkMode() ? 'Cambiar a modo claro' : 'Cambiar a modo oscuro'"
                >
                  @if (themeService.isDarkMode()) {
                    <i-lucide name="sun" [size]="20"></i-lucide>
                  } @else {
                    <i-lucide name="moon" [size]="20"></i-lucide>
                  }
                </button>
                
                <div class="text-right">
                  <div class="text-sm font-bold text-white">{{ currentUser()?.fullName }}</div>
                  <div class="text-xs text-gray-400 flex items-center justify-end gap-1">
                    @switch (currentUser()?.role) {
                      @case ('admin') { <i-lucide name="settings" [size]="12"></i-lucide> <span>Administrador</span> }
                      @case ('caregiver') { <i-lucide name="user-circle" [size]="12"></i-lucide> <span>Cuidador</span> }
                      @case ('user') { <i-lucide name="user-circle" [size]="12"></i-lucide> <span>Paciente</span> }
                    }
                  </div>
                </div>
                <button (click)="logout()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors flex items-center gap-2">
                  <i-lucide name="log-out" [size]="16"></i-lucide> Salir
                </button>
              } @else {
                <a routerLink="/" class="text-gray-300 hover:text-white font-medium transition-colors">Iniciar Sesi√≥n</a>
              }
            </div>
          </div>

          <!-- Mobile Menu Button -->
          <div class="-mr-2 flex md:hidden">
            @if (currentUser()) {
              <button (click)="toggleMenu()" class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white">
                <span class="sr-only">Abrir men√∫</span>
                @if (isMobileMenuOpen()) {
                  <i-lucide name="x" [size]="24"></i-lucide>
                } @else {
                  <i-lucide name="menu" [size]="24"></i-lucide>
                }
              </button>
            }
          </div>
        </div>
      </div>

      <!-- Mobile Menu (Conditional) -->
      @if (isMobileMenuOpen() && currentUser()) {
        <div class="md:hidden bg-gray-800 border-t border-gray-700 animate-slide-down">
          <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
            @if (currentUser()?.role === 'user') {
              <a routerLink="/profile" (click)="closeMenu()" routerLinkActive="bg-gray-900 text-white" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium flex items-center gap-2">
                <i-lucide name="user" [size]="18"></i-lucide> Mi Perfil
              </a>
              <a routerLink="/alerts" (click)="closeMenu()" routerLinkActive="bg-gray-900 text-white" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium flex items-center gap-2">
                <i-lucide name="bell" [size]="18"></i-lucide> Mis Incidencias
              </a>
            } @else {
              <a routerLink="/dashboard" (click)="closeMenu()" routerLinkActive="bg-gray-900 text-white" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium flex items-center gap-2">
                <i-lucide name="activity" [size]="18"></i-lucide> Monitorizaci√≥n
              </a>
              <a routerLink="/devices" (click)="closeMenu()" routerLinkActive="bg-gray-900 text-white" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium flex items-center gap-2">
                <i-lucide name="smartphone" [size]="18"></i-lucide> Dispositivos
              </a>
              <a routerLink="/alerts" (click)="closeMenu()" routerLinkActive="bg-gray-900 text-white" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium flex items-center gap-2">
                <i-lucide name="bell" [size]="18"></i-lucide> Historial
              </a>

              @if (currentUser()?.role === 'admin' || currentUser()?.role === 'caregiver') {
                <a routerLink="/users" (click)="closeMenu()" routerLinkActive="bg-gray-900 text-white" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium flex items-center gap-2">
                  <i-lucide name="users" [size]="18"></i-lucide>
                  {{ isAdmin() ? 'Gesti√≥n Usuarios' : 'Lista Pacientes' }}
                </a>
              }
            }
          </div>
          
          <div class="pt-4 pb-4 border-t border-gray-700">
            <div class="flex items-center px-5">
              <div class="flex-shrink-0">
                <div class="h-10 w-10 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-lg">
                  {{ currentUser()?.fullName?.charAt(0) }}
                </div>
              </div>
              <div class="ml-3">
                <div class="text-base font-medium leading-none text-white">{{ currentUser()?.fullName }}</div>
                <div class="text-sm font-medium leading-none text-gray-400 mt-1 capitalize">{{ currentUser()?.role || 'Usuario' }}</div>
              </div>
              <!-- Bot√≥n de tema m√≥vil -->
              <button
                (click)="themeService.toggleTheme()"
                class="ml-2 p-2 rounded-full bg-gray-700 hover:bg-gray-600 transition-all text-gray-300"
                [title]="themeService.isDarkMode() ? 'Cambiar a modo claro' : 'Cambiar a modo oscuro'"
              >
                @if (themeService.isDarkMode()) {
                  <i-lucide name="sun" [size]="18"></i-lucide>
                } @else {
                  <i-lucide name="moon" [size]="18"></i-lucide>
                }
              </button>
              <button (click)="logout()" class="ml-2 bg-red-600 p-2 rounded-full text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white">
                <i-lucide name="log-out" [size]="20"></i-lucide>
              </button>
            </div>
          </div>
        </div>
      }
    </nav>
  }

  <div class="flex-1 relative bg-gray-100 dark:bg-gray-900 transition-colors duration-300">
    <router-outlet></router-outlet>
  </div>

  @if (currentUser() && showNavbar()) {
    <button class="fab-analytics" routerLink="/analytics">
      <i-lucide name="layout-dashboard" [size]="18"></i-lucide>
      <span>Anal√≠tica</span>
    </button>
    
    <!-- Floating Theme Toggle Button -->
    <button 
      class="fab-theme-toggle" 
      (click)="themeService.toggleTheme()"
      [title]="themeService.isDarkMode() ? 'Modo Claro ‚òÄÔ∏è' : 'Modo Oscuro üåô'"
    >
      @if (themeService.isDarkMode()) {
        <i-lucide name="sun" [size]="24" [strokeWidth]="2.5"></i-lucide>
      } @else {
        <i-lucide name="moon" [size]="24" [strokeWidth]="2.5"></i-lucide>
      }
    </button>
  }

  @if (miniAlert()) {
    <div class="toast-notification" [ngClass]="miniAlert()?.severity">
      <div class="toast-icon">
        @if (miniAlert()?.severity === 'high') { 
          <i-lucide name="alert-triangle" [size]="20"></i-lucide>
        }
        @else if (miniAlert()?.severity === 'medium') { 
          <i-lucide name="bell" [size]="20"></i-lucide>
        }
        @else { 
          <i-lucide name="circle-alert" [size]="20"></i-lucide>
        }
      </div>
      <div class="toast-content">
        <h4>Nueva Alerta Detectada</h4>
        <p>{{ miniAlert()?.message }}</p>
        <small><i-lucide name="map-pin" [size]="12"></i-lucide> {{ miniAlert()?.location }}</small>
      </div>
      <div class="toast-actions">
        <button class="btn-toast-view" (click)="goToDashboardFromMini()">Atender</button>
        <button class="btn-toast-close" (click)="closeMiniAlert()">‚úï</button>
      </div>
      <div class="progress-bar"></div>
    </div>
  }

  <!-- Componente de Notificaciones -->
  <app-notification></app-notification>

</div>