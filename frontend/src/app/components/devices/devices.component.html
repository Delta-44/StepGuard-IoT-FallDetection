<div class="min-h-screen bg-transparent p-8">
  
  <!-- Header -->
  <div class="flex justify-between items-center mb-8 animate-fade-in">
    <div>
      <h2 class="text-3xl font-bold text-base-text flex items-center gap-3">
        <i-lucide name="radio" [size]="32"></i-lucide>
        Sensores Conectados
      </h2>
      <p class="text-gray-600 mt-2">Monitoreo en tiempo real de dispositivos IoT</p>
    </div>
    
    <button 
      (click)="loadDevices()" 
      [disabled]="isLoading()" 
      class="px-6 py-3 bg-primary text-white rounded-xl font-semibold hover:bg-primary-dark transition-all duration-300 hover: hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
    >
      @if (isLoading()) {
        <i-lucide name="clock" class="animate-spin" [size]="20"></i-lucide> Cargando...
      } @else {
        <i-lucide name="activity" [size]="20"></i-lucide> Recargar
      }
    </button>
  </div>

  <!-- Empty State -->
  @if (!isLoading() && devices().length === 0) {
    <div class="bg-white rounded-xl p-12 text-center animate-fade-in">
      <div class="text-6xl mb-4">📡</div>
      <p class="text-gray-500 text-lg">No se han encontrado dispositivos configurados.</p>
    </div>
  }

  <!-- Grid de Dispositivos -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
    
    @for (device of devices(); track device.mac_address) {
      <div 
        class="bg-white rounded-2xl transition-all duration-500 hover:-translate-y-2 overflow-hidden animate-fade-in relative group"
      >
        
        <!-- Indicador de estado superior -->
        <div class="h-1.5 w-full"
          [ngClass]="{
            'bg-gradient-to-r from-operational to-operational-light': device.estado,
            'bg-gradient-to-r from-emergency to-red-600': !device.estado
          }"
        ></div>
        
        <!-- Card Header -->
        <div class="p-6">
          <!-- Título y Estado -->
          <div class="flex justify-between items-start mb-6">
            <div class="flex items-center gap-3 flex-1">
              <div class="p-3 rounded-xl bg-gradient-to-br transition-transform group-hover:scale-110"
                [ngClass]="{
                  'from-operational/10 to-operational/5': device.estado,
                  'from-emergency/10 to-emergency/5': !device.estado
                }"
              >
                <i-lucide name="radio" [size]="24"
                  [ngClass]="{
                    'text-operational': device.estado,
                    'text-emergency': !device.estado
                  }"
                ></i-lucide>
              </div>
              <h3 class="text-xl font-bold text-gray-800">{{ device.nombre }}</h3>
            </div>
            
            <span 
              class="flex items-center gap-2 px-4 py-2 rounded-xl text-xs font-semibold uppercase tracking-wider "
              [ngClass]="{
                'bg-operational/10 text-operational border border-operational/20': device.estado,
                'bg-emergency/10 text-emergency border border-emergency/20 animate-pulse-emergency': !device.estado
              }"
            >
              @if (device.estado) {
                <span class="w-2 h-2 bg-operational rounded-full animate-glow"></span>
              }
              {{ device.estado ? 'online' : 'offline' }}
            </span>
          </div>

          <!-- Info del Dispositivo -->
          <div class="space-y-3">
            <div class="flex items-center justify-between p-3 bg-transparent rounded-xl transition-colors">
              <div class="flex items-center gap-3">
                <i-lucide name="network" [size]="18" class="text-primary"></i-lucide>
                <span class="text-sm font-medium text-gray-600">MAC Address</span>
              </div>
              <span class="text-sm font-semibold text-gray-800 font-mono">{{ device.mac_address }}</span>
            </div>
            
            <div class="flex items-center justify-between p-3 bg-transparent rounded-xl transition-colors">
              <div class="flex items-center gap-3">
                <i-lucide name="zap" [size]="18" class="text-amber-500"></i-lucide>
                <span class="text-sm font-medium text-gray-600">Impactos</span>
              </div>
              <span class="text-sm font-bold px-3 py-1 rounded-lg bg-blue-50 text-blue-700">
                {{ device.total_impactos }}
              </span>
            </div>
            
            <div class="flex items-center justify-between p-3 bg-transparent rounded-xl transition-colors">
              <div class="flex items-center gap-3">
                <i-lucide name="clock" [size]="18" class="text-gray-400"></i-lucide>
                <span class="text-sm font-medium text-gray-600">Última conexión</span>
              </div>
              <span class="text-sm font-semibold text-gray-800">{{ device.ultima_conexion | date:'shortTime' }}</span>
            </div>
          </div>
        </div>

        <!-- Botón Admin -->
        @if (isAdmin()) {
          <div class="px-6 pb-6">
            <button 
              (click)="rebootDevice(device)" 
              class="w-full bg-red-600 text-white py-3 px-4 rounded-xl font-semibold transition-all duration-300 flex items-center justify-center gap-2 group"
            >
              <i-lucide name="refresh-cw" [size]="18"></i-lucide>
              Reiniciar Dispositivo
            </button>
          </div>
        }
      </div>
    }
  </div>

  <!-- PANEL TÉCNICO / DEBUG -->
  <div class="animate-fade-in">
  <!-- Vista Técnica (Solo Admin y Cuidadores) -->
  @if (canViewTechnical()) {
    <button 
      (click)="toggleTechnicalPanel()" 
      class="w-full px-6 py-4 bg-gradient-to-r from-slate-800 to-slate-900 text-white rounded-2xl font-semibold hover:from-slate-700 hover:to-slate-800 transition-all duration-300 mb-4 flex items-center justify-between  border border-slate-700 hover:border-slate-600"
    >
      <span class="flex items-center gap-3">
        <i-lucide name="terminal" [size]="20"></i-lucide>
        VISTA TÉCNICA (DEBUG)
      </span>
      <i-lucide [name]="showTechnicalPanel() ? 'chevron-down' : 'chevron-right'" [size]="24"></i-lucide>
    </button>

    @if (showTechnicalPanel()) {
      <div class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-emerald-400 rounded-2xl p-8 font-mono text-sm animate-slide-down  border border-slate-700">
        
        <h3 class="text-sky-400 text-xl font-bold mb-6 flex items-center gap-3 pb-4 border-b border-slate-700">
          <i-lucide name="cpu" [size]="24"></i-lucide>
          PANEL DE DESARROLLO
        </h3>
        
        <!-- Estados del Sistema -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div class="bg-slate-800/50 rounded-xl p-5 border border-slate-700 hover:border-slate-600 transition-all">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <i-lucide name="alert-triangle" [size]="20" class="text-amber-400"></i-lucide>
                <strong class="text-slate-300">Estado Crítico</strong>
              </div>
              <span 
                class="font-bold px-4 py-2 rounded-lg flex items-center gap-2 "
                [ngClass]="criticalState() ? 'bg-emergency text-white' : 'bg-operational text-white'"
              >
                @if (criticalState()) {
                  <i-lucide name="alert-circle" [size]="16"></i-lucide> TRUE
                } @else {
                  <i-lucide name="check-circle" [size]="16"></i-lucide> FALSE
                }
              </span>
            </div>
          </div>

          <div class="bg-slate-800/50 rounded-xl p-5 border border-slate-700 hover:border-slate-600 transition-all">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <i-lucide name="wifi" [size]="20" class="text-sky-400"></i-lucide>
                <strong class="text-slate-300">Conexión</strong>
              </div>
              <span 
                class="font-bold px-4 py-2 rounded-lg flex items-center gap-2 "
                [ngClass]="connectionStatus() === 'Conectado' ? 'bg-operational text-white' : 'bg-emergency text-white'"
              >
                {{ connectionStatus() }}
                @if (connectionStatus() === 'Conectado') {
                  <span class="inline-block w-2 h-2 rounded-full animate-breathe"></span>
                }
              </span>
            </div>
          </div>
        </div>

        <div class="border-t border-slate-700 my-6"></div>

        <!-- JSON Crudo -->
        <h4 class="text-amber-400 font-semibold mb-4 flex items-center gap-3">
          <i-lucide name="braces" [size]="20"></i-lucide>
          Datos recibidos (JSON)
        </h4>
        <div class="bg-black/70 rounded-xl border border-slate-700 overflow-hidden">
          <pre class="p-5 overflow-x-auto max-h-96 text-xs text-emerald-300">{{ devices() | json }}</pre>
        </div>

        <div class="border-t border-slate-700 my-6"></div>

        <!-- Datos del Acelerómetro -->
        <h4 class="text-amber-400 font-semibold mb-4 flex items-center gap-3">
          <i-lucide name="activity" [size]="20"></i-lucide>
          Datos del Sensor (Acelerómetro)
        </h4>
        <div class="space-y-4">
          @for (device of devices(); track device.mac_address) {
            @if (device.esp32Data) {
              <div 
                class="bg-slate-800/50 rounded-xl p-5 border-l-4 transition-all duration-300 "
                [ngClass]="device.esp32Data.isFallDetected ? 'border-emergency animate-pulse-emergency shadow-emergency/20' : 'border-operational shadow-operational/10'"
              >
                <div class="text-sky-400 font-semibold mb-4 flex items-center gap-2 pb-3 border-b border-slate-700">
                  <i-lucide name="radio" [size]="18"></i-lucide>
                  {{ device.nombre }} ({{ device.mac_address }})
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                  <div class="flex items-center gap-2 bg-slate-900/50 rounded-lg p-3">
                    <i-lucide name="zap" [size]="16" class="text-amber-400"></i-lucide>
                    <span class="text-slate-400">Impactos:</span> 
                    <span class="text-white font-bold ml-auto">{{ device.esp32Data.impact_count }}</span>
                  </div>
                  <div class="flex items-center gap-2 bg-slate-900/50 rounded-lg p-3">
                    <i-lucide name="activity" [size]="16" class="text-red-400"></i-lucide>
                    <span class="text-slate-400">Magnitud:</span> 
                    <span class="text-white font-bold ml-auto">{{ device.esp32Data.impact_magnitude }} m/s²</span>
                  </div>
                  <div class="flex items-center gap-2 bg-slate-900/50 rounded-lg p-3">
                    <i-lucide name="alert-circle" [size]="16" class="text-slate-400"></i-lucide>
                    <span class="text-slate-400">Caída detectada:</span>
                    <span 
                      class="font-bold ml-auto flex items-center gap-1"
                      [ngClass]="device.esp32Data.isFallDetected ? 'text-emergency' : 'text-operational'"
                    >
                      {{ device.esp32Data.isFallDetected ? 'SÍ' : 'NO' }}
                      @if (device.esp32Data.isFallDetected) {
                        <i-lucide name="siren" [size]="16"></i-lucide>
                      }
                    </span>
                  </div>
                  <div class="flex items-center gap-2 bg-slate-900/50 rounded-lg p-3">
                    <i-lucide name="circle-alert" [size]="16" class="text-red-600"></i-lucide>
                    <span class="text-slate-400">Botón SOS:</span>
                    <span 
                      class="font-bold ml-auto"
                      [ngClass]="device.esp32Data.isButtonPressed ? 'text-emergency' : 'text-operational'"
                    >
                      {{ device.esp32Data.isButtonPressed ? 'PRESIONADO' : 'Normal' }}
                    </span>
                  </div>
                  <div class="flex items-center gap-2 bg-slate-900/50 rounded-lg p-3 md:col-span-2">
                    <i-lucide name="network" [size]="16" class="text-purple-400"></i-lucide>
                    <span class="text-slate-400">MAC:</span> 
                    <span class="text-slate-500 ml-auto font-mono text-xs">{{ device.mac_address }}</span>
                  </div>
                </div>
              </div>
            }
          }
        </div>

        <!-- Info Footer -->
        <div class="mt-6 p-4 bg-black/50 rounded-lg border border-gray-700">
          <small class="text-gray-500 block leading-relaxed">
            ℹ️ Este panel muestra datos técnicos para desarrollo y presentación del proyecto IoT.
            <br>
            Los datos son recibidos del ESP32 vía HTTP/MQTT y procesados por el backend.
          </small>
        </div>
      </div>
    }
  }
</div>





