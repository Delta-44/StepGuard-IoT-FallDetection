<div class="profile-container">
  
  <!-- Botón Exportar (NIVEL SUPERIOR - VISIBILIDAD GARANTIZADA) -->
  <div style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; justify-content: flex-end; pointer-events: none;">
    <button
      (click)="exportData()"
      class="pointer-events-auto bg-emerald-500 text-white hover:bg-emerald-600 shadow-xl transform hover:-translate-y-1 transition-all duration-300 py-3 px-6 rounded-full font-bold flex items-center gap-2 border-2 border-white"
      title="Exportar mis datos"
      style="box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4);"
    >
      <i-lucide name="download" [size]="20"></i-lucide>
      <span>Exportar Datos</span>
    </button>
  </div>

  <!-- Header con Información del Paciente -->
  <div class="profile-header" style="position: relative;">

    <div class="avatar-section">
      <div class="avatar">
        {{ currentUser()?.fullName?.charAt(0) || 'P' }}
      </div>
      <div class="user-info">
        <h1>{{ currentUser()?.fullName }}</h1>
        <p class="user-email">{{ currentUser()?.email }}</p>
        <div class="user-details">
          @if (currentUser()?.telefono) {
            <span class="detail-item">
              <i-lucide name="phone" [size]="14"></i-lucide>
              {{ currentUser()?.telefono }}
            </span>
          }
          @if (currentUser()?.direccion) {
            <span class="detail-item">
              <i-lucide name="map-pin" [size]="14"></i-lucide>
              {{ currentUser()?.direccion }}
            </span>
          }
        </div>
      </div>
    </div>
    
    <div class="quick-stats">
      <div class="stat-box">
        <i-lucide name="heart-pulse" [size]="20" class="stat-icon"></i-lucide>
        <span class="stat-value">{{ stats.totalIncidents }}</span>
        <span class="stat-label">Total Incidencias</span>
      </div>
      <div class="stat-box">
        <i-lucide name="calendar" [size]="20" class="stat-icon"></i-lucide>
        <span class="stat-value">{{ stats.thisMonth }}</span>
        <span class="stat-label">Este Mes</span>
      </div>
      <div class="stat-box">
        <i-lucide name="check-circle" [size]="20" class="stat-icon"></i-lucide>
        <span class="stat-value">{{ stats.resolved }}</span>
        <span class="stat-label">Resueltas</span>
      </div>
    </div>
  </div>

  <!-- Calendario de Incidencias -->
  <div class="incidents-section">
    <div class="section-header">
      <h2>
        <i-lucide name="calendar-days" [size]="24"></i-lucide>
        Historial de Incidencias
      </h2>
    </div>

    @if (myAlerts().length === 0) {
      <div class="empty-state">
        <i-lucide name="smile" [size]="48" class="empty-icon"></i-lucide>
        <h3>¡Excelente!</h3>
        <p>No tienes incidencias registradas</p>
      </div>
    } @else {
      <div class="timeline">
        @for (group of groupAlertsByMonth(); track group.month + group.year) {
          <div class="month-group">
            <div class="month-header">
              <span class="month-badge">{{ group.month }} {{ group.year }}</span>
              <span class="month-count">{{ group.alerts.length }} incidencia(s)</span>
            </div>
            
            <div class="alerts-list">
              @for (alert of group.alerts; track alert.id) {
                <div class="alert-card" [style.border-left-color]="getSeverityColor(alert.severity)">
                  <div class="alert-header">
                    <div class="alert-info">
                      <span class="alert-date">
                        <i-lucide name="clock" [size]="14"></i-lucide>
                        {{ alert.timestamp | date:'dd/MM/yyyy HH:mm' }}
                      </span>
                      <span class="alert-location">
                        <i-lucide name="map-pin" [size]="14"></i-lucide>
                        {{ alert.location }}
                      </span>
                    </div>
                    <div class="alert-badges">
                      <span class="severity-badge" [style.background-color]="getSeverityColor(alert.severity)">
                        {{ getSeverityLabel(alert.severity) }}
                      </span>
                      <span class="status-badge" 
                        [ngClass]="{
                          'status-pending': alert.status === 'pendiente',
                          'status-resolved': alert.status === 'atendida',
                          'status-false': alert.status === 'falsa_alarma'
                        }">
                        {{ getStatusLabel(alert.status) }}
                      </span>
                    </div>
                  </div>
                  
                  <div class="alert-body">
                    <p class="alert-message">
                      <i-lucide name="alert-circle" [size]="16"></i-lucide>
                      {{ alert.message }}
                    </p>
                    
                    @if (alert.resolutionNotes) {
                      <div class="alert-notes">
                        <strong>Notas de atención:</strong>
                        <p>{{ alert.resolutionNotes }}</p>
                      </div>
                    }
                    
                    @if (alert.caregiverName) {
                      <p class="alert-caregiver">
                        <i-lucide name="user-check" [size]="14"></i-lucide>
                        Atendido por: {{ alert.caregiverName }}
                      </p>
                    }
                  </div>
                </div>
              }
            </div>
          </div>
        }
      </div>
    }
  </div>

</div>
