<div class="min-h-screen bg-transparent p-8">
  
  <!-- Header -->
  <div class="mb-8 animate-fade-in">
    <h2 class="text-3xl font-bold text-base-text flex items-center gap-3">
      <i-lucide name="users" [size]="32"></i-lucide>
      Gestión de Usuarios
    </h2>
    <p class="text-gray-600 mt-2">Administración de pacientes y personal del sistema</p>
  </div>

  <!-- Loading State -->
  @if (isLoading) {
    <div class="flex flex-col items-center justify-center h-64 animate-fade-in">
      <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4"></div>
      <p class="text-gray-600 text-lg">Cargando datos...</p>
    </div>
  } @else {
    
    <!-- Tabla de Usuarios -->
    <div class="bg-transparent/50 rounded-xl  overflow-hidden animate-fade-in">
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-primary text-white">
            <tr>
              <th class="px-6 py-4 text-left font-semibold">NOMBRE</th>
              <th class="px-6 py-4 text-left font-semibold">EMAIL</th>
              <th class="px-6 py-4 text-left font-semibold">ROL</th>
              <th class="px-6 py-4 text-left font-semibold">ESTADO</th>
              
              @if (canViewHistory()) {
                <th class="px-6 py-4 text-center font-semibold">HISTORIAL</th>
              }

              @if (isAdmin()) {
                <th class="px-6 py-4 text-center font-semibold">ACCIONES</th>
              }
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            @for (user of users; track user.email) {
              <tr class="hover:bg-transparent transition-colors duration-200">
                <td class="px-6 py-4">
                  <div class="flex flex-col">
                    <span class="text-base-text font-semibold">{{ user.fullName }}</span> 
                    <small class="text-gray-500">{{ user.username || 'N/A' }}</small>
                  </div>
                </td>
                <td class="px-6 py-4 text-gray-700">{{ user.email }}</td>
                <td class="px-6 py-4">
                  <span 
                    class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold uppercase"
                    [ngClass]="{
                      'bg-red-600 text-white': user.role === 'admin',
                      'bg-primary text-white': user.role === 'caregiver',
                      'bg-operational text-white': user.role === 'user'
                    }"
                  >
                    {{ user.role === 'user' ? 'PACIENTE' : (user.role | uppercase) }}
                  </span>
                </td>
                <td class="px-6 py-4">
                  <div class="flex items-center gap-2">
                    <span 
                      class="w-3 h-3 rounded-full"
                      [ngClass]="user.status === 'active' ? 'bg-operational animate-glow' : 'bg-gray-400'"
                    ></span>
                    <span 
                      class="font-medium capitalize"
                      [ngClass]="user.status === 'active' ? 'text-operational' : 'text-gray-500'"
                    >
                      {{ user.status }}
                    </span>
                  </div>
                </td>

                @if (canViewHistory()) {
                  <td class="px-6 py-4 text-center">
                    <button 
                      class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-all duration-300 hover: hover:-translate-y-0.5 flex items-center gap-2 mx-auto"
                      (click)="openHistoryModal(user)" 
                      title="Ver Alertas"
                    >
                      <i-lucide name="clipboard-list" [size]="16"></i-lucide> Historial
                    </button>
                  </td>
                }

                @if (isAdmin()) {
                  <td class="px-6 py-4">
                    <div class="flex justify-center gap-2">
                      <button 
                        class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all duration-300 hover:shadow-lg flex items-center gap-1"
                        (click)="openEditModal(user)" 
                        title="Editar Usuario"
                      >
                        <i-lucide name="square-pen" [size]="16"></i-lucide>
                      </button>
                      <button 
                        class="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all duration-300 hover:shadow-lg flex items-center gap-1"
                        (click)="deleteUser(user.id)" 
                        title="Eliminar Usuario"
                      >
                        <i-lucide name="trash-2" [size]="16"></i-lucide>
                      </button>
                    </div>
                  </td>
                }
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  }

  <!-- Modal de Edición Mejorado -->
  @if (isEditModalOpen) {
    <div class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center animate-fade-in" (click)="closeEditModal()">
      <div class="bg-white rounded-3xl w-full max-w-lg mx-4 animate-slide-down shadow-2xl overflow-hidden" (click)="$event.stopPropagation()">
        
        <!-- Header con Gradiente -->
        <div class="bg-gradient-to-br from-blue-600 to-blue-700 text-white px-8 py-8 relative overflow-hidden">
          <div class="relative z-10">
            <div class="flex items-center gap-3 mb-2">
              <div class="p-3 bg-white/20 rounded-xl backdrop-blur-sm">
                <i-lucide name="user" [size]="28"></i-lucide>
              </div>
              <div>
                <h3 class="text-3xl font-black">Editar Usuario</h3>
                <p class="text-sm text-blue-100 font-medium">Actualizar información del perfil</p>
              </div>
            </div>
          </div>
          <!-- Decoración de fondo -->
          <div class="absolute top-0 right-0 w-48 h-48 bg-white/10 rounded-full -mr-24 -mt-24"></div>
        </div>
        
        <form (ngSubmit)="saveUserChanges()" class="p-8 space-y-6">
          <!-- Campo Nombre -->
          <div>
            <label class="block text-gray-900 font-bold mb-3 text-sm flex items-center gap-2">
              <i-lucide name="user" [size]="16"></i-lucide>
              Nombre Completo
            </label>
            <input 
              type="text" 
              [(ngModel)]="selectedUser.fullName" 
              name="fullName" 
              required
              placeholder="Ej: Juan Pérez García"
              class="w-full px-4 py-4 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-500/20 transition-all duration-300 text-gray-900 bg-gray-50"
            >
          </div>
          
          <!-- Campo Email -->
          <div>
            <label class="block text-gray-900 font-bold mb-3 text-sm flex items-center gap-2">
              <i-lucide name="mail" [size]="16"></i-lucide>
              Correo Electrónico
            </label>
            <input 
              type="email" 
              [(ngModel)]="selectedUser.email" 
              name="email" 
              required
              placeholder="ejemplo@correo.com"
              class="w-full px-4 py-4 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-500/20 transition-all duration-300 text-gray-900 bg-gray-50"
            >
          </div>

          <!-- Campo Rol con Cards -->
          <div>
            <label class="block text-gray-900 font-bold mb-3 text-sm flex items-center gap-2">
              <i-lucide name="shield" [size]="16"></i-lucide>
              Rol del Usuario
            </label>
            <div class="relative">
              <select 
                [(ngModel)]="selectedUser.role" 
                name="role"
                class="w-full px-4 py-4 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-500/20 transition-all duration-300 text-gray-900 font-semibold bg-white appearance-none cursor-pointer"
              >
                <option value="admin">🔴 Administrador - Control total del sistema</option>
                <option value="caregiver">🔵 Cuidador - Gestión de pacientes</option>
                <option value="user">🟢 Paciente - Usuario monitoreado</option>
              </select>
              <i-lucide name="chevron-down" [size]="20" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i-lucide>
            </div>
          </div>

          <!-- Botones de Acción -->
          <div class="flex gap-3 pt-4">
            <button 
              type="button" 
              class="flex-1 px-6 py-4 border-2 border-gray-300 text-gray-700 rounded-xl font-bold hover:bg-gray-100 hover:border-gray-400 transition-all duration-300 flex items-center justify-center gap-2"
              (click)="closeEditModal()"
            >
              <i-lucide name="x" [size]="18"></i-lucide>
              Cancelar
            </button>
            <button 
              type="submit" 
              class="flex-1 px-6 py-4 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-xl font-bold hover:from-green-700 hover:to-green-800 transition-all duration-300 hover:-translate-y-1 hover:shadow-xl flex items-center justify-center gap-2"
            >
              <i-lucide name="check-circle" [size]="20"></i-lucide>
              Guardar Cambios
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Modal de Historial -->
  @if (isHistoryModalOpen) {
    <div class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center animate-fade-in" (click)="closeHistoryModal()">
      <div class="bg-transparent/50 rounded-2xl  w-full max-w-3xl mx-4 max-h-[90vh] flex flex-col animate-slide-down" (click)="$event.stopPropagation()">
        
        <!-- Header del Modal -->
        <div class="bg-primary text-white px-8 py-6 rounded-t-2xl flex justify-between items-center">
          <h3 class="text-2xl font-bold flex items-center gap-2">
            <i-lucide name="clipboard-list" [size]="28"></i-lucide>
            Historial: {{ selectedHistoryUserName }}
          </h3>
          <button 
            class="text-3xl hover:bg-white/20 w-10 h-10 rounded-full transition-all duration-300"
            (click)="closeHistoryModal()"
          >
            ✕
          </button>
        </div>
  
        <!-- Contenido Scrollable -->
        <div class="flex-1 overflow-y-auto p-8">
          @if (userHistory.length === 0) {
            <div class="flex flex-col items-center justify-center h-48 text-gray-400">
              <div class="text-6xl mb-3">✅</div>
              <p class="text-lg">Sin incidentes registrados.</p>
            </div>
          } @else {
            <div class="space-y-4">
              @for (alert of userHistory; track alert.id) {
                <div 
                  class="border-l-4 rounded-lg p-6  hover: transition-all duration-300 animate-fade-in"
                  [ngClass]="{
                    'border-emergency bg-emergency/5': alert.severity === 'critical',
                    'border-red-500 bg-red-50': alert.severity === 'high',
                    'border-preventive bg-preventive/5': alert.severity === 'medium',
                    'border-primary bg-blue-50': alert.severity === 'low'
                  }"
                >
                  <!-- Timestamp -->
                  <div class="text-sm text-gray-500 font-medium mb-2">
                    🕒 {{ alert.timestamp | date:'dd MMM, HH:mm' }}
                  </div>
                  
                  <!-- Mensaje -->
                  <div class="mb-3">
                    <strong 
                      class="text-lg block mb-1"
                      [ngClass]="{
                        'text-emergency': alert.severity === 'critical',
                        'text-red-600': alert.severity === 'high',
                        'text-preventive': alert.severity === 'medium',
                        'text-primary': alert.severity === 'low'
                      }"
                    >
                      {{ alert.message }}
                    </strong>
                    
                    <div class="text-gray-700 text-sm">
                      📍 {{ alert.location }}
                    </div>
                  </div>

                  <!-- Notas de Resolución -->
                  @if (alert.notes) {
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-3">
                      <p class="text-gray-700 italic mb-2">"{{ alert.notes }}"</p>
                      <div class="text-right text-sm">
                        <span class="text-primary font-semibold">— {{ alert.attendedBy }}</span>
                      </div>
                    </div>
                  }

                  <!-- Metadata -->
                  <div class="flex items-center gap-3 mt-3">
                    <span 
                      class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold uppercase"
                      [ngClass]="{
                        'bg-emergency text-white': alert.severity === 'critical',
                        'bg-red-500 text-white': alert.severity === 'high',
                        'bg-preventive text-white': alert.severity === 'medium',
                        'bg-primary text-white': alert.severity === 'low'
                      }"
                    >
                      {{ alert.severity }}
                    </span>
                    
                    <span 
                      class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold"
                      [ngClass]="{
                        'bg-operational text-white': alert.status === 'atendida',
                        'bg-transparent0 text-white': alert.status === 'falsa_alarma',
                        'bg-preventive text-white': alert.status === 'pendiente'
                      }"
                    >
                      @if (alert.status === 'atendida') {
                        ✅ Atendida
                      } @else if (alert.status === 'falsa_alarma') {
                        🚫 Falsa Alarma
                      } @else {
                        ⚠️ Pendiente
                      }
                    </span>
                  </div>

                </div>
              }
            </div>
          }
        </div>
      </div>
    </div>
  }
</div>


